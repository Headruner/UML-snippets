@startuml Firmware_Update_Checks
'skinparam monochrome true
'skinparam defaultFontName Arial
'left to right direction

== Physical Detection (Connected/Not Connected) ==
participant "PC System" as pc
participant "Device Manager API" as api
participant "AIO Cooler" as aio
participant "Air Cooler" as airCooler
participant "Case Fan" as caseFan
participant "Controller" as controller

pc -> api: Power On
activate api

== For All Device Types ==
alt device is connected
    api --> aio: Check Physical Connection (USB/I2C/etc.)
    api --> airCooler: Check Physical Connection
    api --> caseFan: Check Physical Connection
    api --> controller: Check Physical Connection

    group AIO Specific Checks
        aio -> aio: Verify I/O Pins Active
        aio --> api: Connection Confirmed
    end

    group Air Cooler Specific Checks
        airCooler -> airCooler: Verify Rotation Sensors
        airCooler --> api: Connection Confirmed
    end

    group Case Fan Specific Checks
        caseFan -> caseFan: Check PWM Signals
        caseFan --> api: Connection Confirmed
    end

    controller -> controller: Initialize Communication Protocol
    controller --> api: Controller Ready (transparent to UI)

else device not connected
    api --> aio: Device Disconnected
    api --> airCooler: Device Disconnected
    api --> caseFan: Device Disconnected
    deactivate api
end

== Device Status Detection (Active/Inactive/Bootloader) ==
participant "Firmware Manager" as fm
note right of pc: <<After Physical Connection>>\n<<Firmware Manager Initializes>>
pc -> fm: Initialize Firmware Check Sequence
activate fm

group For Each Connected Device
    fm --> aio: Request Status Report
    fm --> airCooler: Request Status Report
    fm --> caseFan: Request Status Report

    alt device responds successfully
        group AIO Case
            aio -> aio: Self Test Routine
            aio --> fm: Firmware Version 1.2\nStatus: Normal Operation
        end

        group Air Cooler Case
            airCooler -> airCooler: Calibration Check
            airCooler --> fm: Firmware Version 3.4\nStatus: Active
        end

        group Case Fan Case
            caseFan -> caseFan: RPM Verification
            caseFan --> fm: Firmware Version 2.1\nStatus: Operational
        end
    else device responds with error
        group Common Error Cases
            aio --> fm: Firmware Version 1.2\nStatus: Bootloader Mode\nUpdate Pending
            airCooler --> fm: No Response\nStatus: Disconnected/Failed
            caseFan --> fm: Firmware Mismatch\nStatus: Inactive
        end
    else device takes too long to respond (>5s)
        group Timeout Cases
            aio --> fm: Timeout\nStatus: Unknown (Assume Bootloader)
            airCooler --> fm: Timeout\nStatus: Disconnected
            caseFan --> fm: Timeout\nStatus: Firmware Corrupt
        end

    note right of fm: <<For each device that responds with:\n- Normal operation → Show in UI\n- Any error/timeout → Trigger troubleshooting>>
end

== Controller-Specific Logic (Hidden from UI) ==
group Controller Check Sequence (Transparent)
    pc -> controller: Request Version Info
    activate controller

    alt controller in normal state
        controller --> fm: Controller FW 2.5\nAll devices operational
    else controller in bootloader
        controller --> fm: Bootloader Mode v1.3\nUpdate in progress...
        note right of fm: <<Controller hidden from UI,\nbut dependent AIO fans shown with "Controller Update Pending" tooltip>>
        fm -> aio: Get Status with Controller Context
        aio --> fm: Firmware 1.2\nStatus: Operational (But controlled by updating controller)
    else controller fails to respond
        fm -> caseFan: Query Directly via Alternative Path
        caseFan --> fm: Status Normal (Controller offline)
        note right of fm: <<Display all devices normally,\nadd "Controller Offline" system alert>>
    end

    deactivate controller
end

== Final UI State Determination ==
group Logical Issues Resolution
    alt All checks pass
        fm -> pc: Render Normal Operation View
        note left of pc: <<Show all compatible devices\nwith current status>>\n<<No warnings shown>>
    else Firmware issues detected
        fm -> pc: Render Warning States
        note left of pc: <<Show devices with:\n- Version numbers\n- Update available indicators\n- Error icons for failed devices>>
    else Controller-specific issues
        fm -> pc: Render Device-Specific Messages
        note left of pc: <<Show all end-devices normally,\nhide controller from UI\nAdd tooltips about update status>>
end

deactivate fm
pc -> api: Terminate Check Sequence

@enduml
